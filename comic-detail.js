document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("comic-detail-content"),e=document.getElementById("loading-message"),n=document.getElementById("genre-dropdown-menu"),a=document.getElementById("search-form"),s=document.getElementById("search-input");function r(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))}let o=[],c=!0;function i(){const t=document.getElementById("chapter-list-detail");if(!t)return;if(t.innerHTML="",0===o.length)return void(t.innerHTML='<li class="list-group-item">Chưa có chương nào.</li>');const e=[...o];e.sort((t,e)=>{const n=parseFloat(t.chapter_name.match(/[\d.]+/)?.[0]||0),a=parseFloat(e.chapter_name.match(/[\d.]+/)?.[0]||0);return c?n-a:a-n}),e.forEach(e=>{const n=e.chapter_name||"Không rõ",a=o.findIndex(t=>t.chapter_api_data===e.chapter_api_data),s=`chapter-reader.html?comicSlug=${encodeURIComponent(r("slug"))}&chapterIndex=${a}&chapter=${encodeURIComponent(n)}`,c=document.createElement("li");c.className="list-group-item d-flex justify-content-between align-items-center",c.innerHTML=`\n                <a href="${s}">\n                    Chương ${n}\n                </a>\n                <small class="text-muted">${e.chapter_title||""}</small>\n            `,t.appendChild(c)})}a.addEventListener("submit",t=>{t.preventDefault();const e=s.value.trim();e&&(window.location.href=`search.html?keyword=${encodeURIComponent(e)}`)}),async function(){const n=r("slug");if(!n)return t.innerHTML='<p class="text-center text-danger">Không tìm thấy slug truyện.</p>',void(e.style.display="none");const a=`https://otruyenapi.com/v1/api/truyen-tranh/${n}`;try{const s=(await axios.get(a)).data.data.item;if(s){e.style.display="none";const a="https://img.otruyenapi.com/uploads/comics/"+s.thumb_url,r=s.category.map(t=>`<span class="badge bg-primary me-1">${t.name}</span>`).join(""),l=s.author&&s.author.length>0&&""!==s.author[0]?s.author.join(", "):"Đang cập nhật",h="ongoing"===s.status?"Đang tiến hành":"Hoàn thành";if(s.chapters&&s.chapters.length>0&&s.chapters[0].server_data&&s.chapters[0].server_data.length>0){const t=s.chapters[0].server_data,e=new Set,a=[];[...t].sort((t,e)=>parseFloat(t.chapter_name.match(/[\d.]+/)?.[0]||0)-parseFloat(e.chapter_name.match(/[\d.]+/)?.[0]||0)).forEach(t=>{t.chapter_name&&!e.has(t.chapter_name)&&(a.push(t),e.add(t.chapter_name))}),o=a,sessionStorage.setItem(`comicChapters_${n}`,JSON.stringify(o)),sessionStorage.setItem(`comicName_${n}`,s.name)}else o=[],sessionStorage.removeItem(`comicChapters_${n}`),sessionStorage.removeItem(`comicName_${n}`);t.innerHTML=`\n                    <div class="col-md-4 text-center">\n                        <img src="${a}" alt="${s.name}" class="img-fluid rounded mb-3">\n                    </div>\n                    <div class="col-md-8">\n                        <h2>${s.name}</h2>\n                        <p><strong>Tên khác:</strong> ${s.origin_name.filter(t=>""!==t).join(", ")||"Đang cập nhật"}</p>\n                        <p><strong>Tác giả:</strong> ${l}</p>\n                        <p><strong>Thể loại:</strong> ${r}</p>\n                        <p><strong>Trạng thái:</strong> <span class="badge ${"ongoing"===s.status?"bg-info":"bg-success"}">${h}</span></p>\n                        <p><strong>Cập nhật cuối:</strong> ${new Date(s.updatedAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric"})}</p>\n                        <p><strong>Mô tả:</strong> ${s.content||"Đang cập nhật."}</p>\n                    </div>\n                    <div class="col-12 mt-4">\n                        <div class="d-flex justify-content-between align-items-center mb-3">\n                            <h3>Danh sách chương</h3>\n                            <button class="btn btn-sm btn-secondary" id="sort-chapters-detail-btn">Xếp từ mới nhất</button>\n                        </div>\n                        <ul class="list-group list-group-flush" id="chapter-list-detail">\n                            </ul>\n                    </div>\n                `,i();const d=document.getElementById("sort-chapters-detail-btn");d&&d.addEventListener("click",()=>{c=!c,i(),d.textContent=c?"Xếp từ mới nhất":"Xếp từ cũ nhất"})}else t.innerHTML='<p class="text-center text-danger">Không tìm thấy thông tin truyện.</p>',e.style.display="none"}catch(n){console.error("Lỗi khi tải chi tiết truyện:",n),t.innerHTML='<p class="text-center text-danger">Có lỗi xảy ra khi tải chi tiết truyện. Vui lòng thử lại sau.</p>',e.style.display="none"}}(),async function(){try{const t=(await axios.get("https://otruyenapi.com/v1/api/the-loai")).data.data.items;n.innerHTML="",t.forEach(t=>{const e=document.createElement("li");e.innerHTML=`<a class="dropdown-item" href="genre.html?genre=${t.slug}">${t.name}</a>`,n.appendChild(e)})}catch(t){console.error("Lỗi khi tải thể loại:",t),n.innerHTML='<li><a class="dropdown-item" href="#">Lỗi tải thể loại</a></li>'}}()});
