document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("comic-list"),e=document.getElementById("loading-message"),n=document.getElementById("pagination"),a=document.getElementById("section-title"),r=document.getElementById("search-form"),i=document.getElementById("search-input"),s=document.getElementById("genre-dropdown-menu");let c=1,l="";async function o(r=1,i=""){t.innerHTML="",e.style.display="block",c=r,l=i;const s={page:r,limit:24,keyword:i};try{const c=(await axios.get("https://otruyenapi.com/v1/api/tim-kiem",{params:s})).data.data,l=c.items||[];e.style.display="none",a.textContent=i?`Kết quả tìm kiếm cho: "${i}"`:"Tìm kiếm truyện",l.length>0?(t.innerHTML="",l.forEach(e=>{const n=e.slug||"default-slug",a="https://img.otruyenapi.com/uploads/comics/"+(e.thumb_url||"no-image.jpg"),r=e.category&&Array.isArray(e.category)?e.category.map(t=>t.name).join(", "):"Đang cập nhật",i=e.author&&Array.isArray(e.author)&&e.author.length>0&&""!==e.author[0]?e.author.join(", "):"Đang cập nhật",s="ongoing"===e.status?"Đang tiến hành":"Hoàn thành";let c="Chưa cập nhật";e.chaptersLatest&&e.chaptersLatest.length>0?c=`Chapter ${e.chaptersLatest[0].chapter_name}`:e.chaptersLatest&&e.chaptersLatest.chapter_name&&(c=`Chapter ${e.chaptersLatest.chapter_name}`);const l=`\n                        <div class="col-6 col-md-3 col-lg-2 mb-4">\n                            <div class="card h-100 comic-card">\n                                <a href="comic-detail.html?slug=${n}">\n                                    <img src="${a}" class="card-img-top" alt="${e.name}">\n                                    <div class="card-body">\n                                        <h5 class="card-title">${e.name}</h5>\n                                        <p class="card-text small text-muted"><strong>Thể loại:</strong> ${r}</p>\n                                        <p class="card-text small text-muted"><strong>Tác giả:</strong> ${i}</p>\n                                        <p class="card-text small text-muted"><strong>Trạng thái:</strong> ${s}</p>\n                                        <p class="card-text small text-primary mt-auto"><strong>Mới nhất:</strong> ${c}</p>\n                                    </div>\n                                </a>\n                            </div>\n                        </div>\n                    `;t.innerHTML+=l}),function(t,e,a){n.innerHTML="";const r=Math.ceil(t/24);if(r<=1)return;const i=5;let s,c;if(r<=i)s=1,c=r;else{const t=Math.floor(i/2),n=Math.ceil(i/2)-1;e<=t?(s=1,c=i):e+n>=r?(s=r-i+1,c=r):(s=e-t,c=e+n)}n.innerHTML+=`\n            <li class="page-item ${1===e?"disabled":""}">\n                <a class="page-link" href="#" data-page="${e-1}" data-keyword="${a}">Trước</a>\n            </li>\n        `;for(let t=s;t<=c;t++)n.innerHTML+=`\n                <li class="page-item ${t===e?"active":""}">\n                    <a class="page-link" href="#" data-page="${t}" data-keyword="${a}">${t}</a>\n                </li>\n            `;n.innerHTML+=`\n            <li class="page-item ${e===r?"disabled":""}">\n                <a class="page-link" href="#" data-page="${e+1}" data-keyword="${a}">Sau</a>\n            </li>\n        `,n.querySelectorAll(".page-link").forEach(t=>{t.addEventListener("click",t=>{t.preventDefault();const n=parseInt(t.target.dataset.page),a=t.target.dataset.keyword;n>0&&n<=r&&n!==e&&o(n,a)})})}(c.params.pagination.totalItems,r,i)):(t.innerHTML='<p class="text-center text-muted">Không tìm thấy truyện nào phù hợp.</p>',n.innerHTML="")}catch(n){console.error("Lỗi khi tải kết quả tìm kiếm:",n),t.innerHTML='<p class="text-center text-danger">Có lỗi xảy ra khi tải kết quả tìm kiếm. Vui lòng thử lại sau.</p>',e.style.display="none"}}r.addEventListener("submit",e=>{e.preventDefault();const r=i.value.trim();r?(o(1,r),history.pushState(null,"",`search.html?keyword=${encodeURIComponent(r)}`)):(a.textContent="Tìm kiếm truyện",t.innerHTML='<p class="text-center text-muted">Vui lòng nhập từ khóa để tìm kiếm truyện.</p>',n.innerHTML="",history.pushState(null,"","search.html"))});const m=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))}("keyword");m?(i.value=m,o(1,m)):(t.innerHTML='<p class="text-center text-muted">Vui lòng nhập từ khóa để tìm kiếm truyện.</p>',e.style.display="none",a.textContent="Tìm kiếm truyện"),async function(){try{const t=(await axios.get("https://otruyenapi.com/v1/api/the-loai")).data.data.items;s.innerHTML="",t.forEach(t=>{const e=document.createElement("li");e.innerHTML=`<a class="dropdown-item" href="genre.html?genre=${t.slug}">${t.name}</a>`,s.appendChild(e)})}catch(t){console.error("Lỗi khi tải thể loại:",t),s.innerHTML='<li><a class="dropdown-item" href="#">Lỗi tải thể loại</a></li>'}}()});
