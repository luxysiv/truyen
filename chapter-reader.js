document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("chapter-content"),t=document.getElementById("loading-message"),n=document.getElementById("chapter-name"),a=document.getElementById("comic-name-link"),c=document.getElementById("chapter-title"),r=document.getElementById("prev-chapter-btn-bottom"),s=document.getElementById("next-chapter-btn-bottom");let i=[],o=-1,h="",l="";function d(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function g(a){if(a>=0&&a<i.length){o=a;const d=i[o],g=d.chapter_name||"Không rõ",p=d.chapter_api_data,m=`chapter-reader.html?comicSlug=${encodeURIComponent(h)}&chapterIndex=${o}`;window.history.pushState({path:m},"",m),n&&(n.textContent=`Chương ${g}`),c&&(c.textContent=`${l} - Chương ${g}`),document.title=`${l} - Chương ${g}`,async function(n){e.innerHTML="",t.style.display="block";try{const a=await axios.get(n),c=a.data.data.item,r=a.data.data.domain_cdn;if(c&&c.chapter_image&&c.chapter_image.length>0){t.style.display="none";let n="";const a=c.chapter_path;c.chapter_image.forEach(e=>{const t=`${r}/${a}/${e.image_file}`;n+=`<img src="${t}" alt="Trang ${e.image_page}">`}),e.innerHTML=n}else e.innerHTML='<p class="text-center text-danger">Không tìm thấy hình ảnh cho chương này.</p>',t.style.display="none"}catch(n){console.error("Lỗi khi tải hình ảnh chương:",n);let a="Có lỗi xảy ra khi tải chương. ";"ERR_BAD_REQUEST"===n.code||404===n.response?.status?a+="Tài nguyên chương không tồn tại hoặc đã bị xóa.":n.message.includes("Network Error")?a+="Lỗi mạng. Vui lòng kiểm tra kết nối internet của bạn.":a+="Vui lòng thử lại sau.",e.innerHTML=`<p class="text-center text-danger">${a}</p>`,t.style.display="none"}}(p),function(){o>0?r.classList.remove("d-none"):r.classList.add("d-none");o<i.length-1?s.classList.remove("d-none"):s.classList.add("d-none")}(),window.scrollTo(0,0)}}!async function(){if(h=d("comicSlug"),o=parseInt(d("chapterIndex")),!h||isNaN(o))return e.innerHTML='<p class="text-center text-danger">Thiếu thông tin truyện hoặc chương.</p>',void(t.style.display="none");const n=sessionStorage.getItem(`comicChapters_${h}`),c=sessionStorage.getItem(`comicName_${h}`);if(n&&c)i=JSON.parse(n),l=c;else{const n=`https://otruyenapi.com/v1/api/truyen-tranh/${h}`;try{const a=(await axios.get(n)).data.data.item;if(!(a&&a.chapters&&a.chapters.length>0&&a.chapters[0].server_data&&a.chapters[0].server_data.length>0))return e.innerHTML='<p class="text-center text-danger">Không tìm thấy danh sách chương cho truyện này.</p>',void(t.style.display="none");{l=a.name;const e=a.chapters[0].server_data,t=[],n=new Set;[...e].sort((e,t)=>parseFloat(e.chapter_name.match(/[\d.]+/)?.[0]||0)-parseFloat(t.chapter_name.match(/[\d.]+/)?.[0]||0)).forEach(e=>{e.chapter_name&&!n.has(e.chapter_name)&&(t.push(e),n.add(e.chapter_name))}),i=t,sessionStorage.setItem(`comicChapters_${h}`,JSON.stringify(i)),sessionStorage.setItem(`comicName_${h}`,l)}}catch(n){return console.error("Lỗi khi tải lại chi tiết truyện để lấy chương:",n),e.innerHTML='<p class="text-center text-danger">Không thể tải danh sách chương. Vui lòng thử lại sau.</p>',void(t.style.display="none")}}if(0===i.length||o<0||o>=i.length)return e.innerHTML='<p class="text-center text-danger">Chương không hợp lệ hoặc không tồn tại.</p>',void(t.style.display="none");a&&(a.href=`comic-detail.html?slug=${encodeURIComponent(h)}`,a.textContent=l),g(o),r&&r.addEventListener("click",()=>g(o-1)),s&&s.addEventListener("click",()=>g(o+1))}()});
