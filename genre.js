document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("comic-list"),e=document.getElementById("loading-message"),a=document.getElementById("section-title"),n=document.getElementById("current-genre-name"),s=document.getElementById("pagination"),i=document.getElementById("genre-dropdown-menu"),c=document.getElementById("search-form"),l=document.getElementById("search-input"),o="https://otruyenapi.com/v1/api/the-loai";let r="";const d=new URLSearchParams(window.location.search);async function p(i,c=1){if(t.innerHTML="",e.style.display="block",s.innerHTML="",!i)return t.innerHTML='<p class="text-center text-muted">Không có thể loại được chọn.</p>',e.style.display="none",void(a.textContent="Truyện theo thể loại");try{const a=(await axios.get(o)).data.data.items.find(t=>t.slug===i);n.textContent=a?a.name:i.replace(/-/g," ").toUpperCase();const l=(await axios.get(`https://otruyenapi.com/v1/api/the-loai/${i}?page=${c}`)).data.data,d=l.items||[],m=l.params?.pagination?.totalItems||0,h=Math.ceil(m/24);e.style.display="none",d.length>0?(d.forEach(e=>{const a=e.slug||"default-slug",n="https://img.otruyenapi.com/uploads/comics/"+(e.thumb_url||"no-image.jpg"),s=e.category&&Array.isArray(e.category)?e.category.map(t=>t.name).join(", "):"Đang cập nhật",i=e.author&&Array.isArray(e.author)&&e.author.length>0&&""!==e.author[0]?e.author.join(", "):"Đang cập nhật",c="ongoing"===e.status?"Đang tiến hành":"completed"===e.status?"Hoàn thành":"Chưa xác định";let l="Chưa cập nhật";e.chaptersLatest&&e.chaptersLatest.length>0?l=`Chapter ${e.chaptersLatest[0].chapter_name}`:e.chaptersLatest&&"object"==typeof e.chaptersLatest&&e.chaptersLatest.chapter_name&&(l=`Chapter ${e.chaptersLatest.chapter_name}`);const o=`\n                        <div class="col-6 col-md-3 col-lg-2 mb-4">\n                            <div class="card h-100 comic-card">\n                                <a href="comic-detail.html?slug=${a}">\n                                    <img src="${n}" class="card-img-top" alt="${e.name}">\n                                    <div class="card-body">\n                                        <h5 class="card-title">${e.name}</h5>\n                                        <p class="card-text small text-muted"><strong>Thể loại:</strong> ${s}</p>\n                                        <p class="card-text small text-muted"><strong>Tác giả:</strong> ${i}</p>\n                                        <p class="card-text small text-muted"><strong>Trạng thái:</strong> ${c}</p>\n                                        <p class="card-text small text-primary mt-auto"><strong>Mới nhất:</strong> ${l}</p>\n                                    </div>\n                                </a>\n                            </div>\n                        </div>\n                    `;t.innerHTML+=o}),function(t,e){s.innerHTML="";const a=5;let n=Math.max(1,e-Math.floor(a/2)),i=Math.min(t,n+a-1);i-n+1<a&&(n=Math.max(1,i-a+1));const c=document.createElement("li");c.classList.add("page-item"),1===e&&c.classList.add("disabled");if(c.innerHTML=`<a class="page-link" href="#" data-page="${e-1}">Trước</a>`,s.appendChild(c),n>1){const t=document.createElement("li");if(t.classList.add("page-item"),t.innerHTML='<a class="page-link" href="#" data-page="1">1</a>',s.appendChild(t),n>2){const t=document.createElement("li");t.classList.add("page-item","disabled"),t.innerHTML='<span class="page-link">...</span>',s.appendChild(t)}}for(let t=n;t<=i;t++){const a=document.createElement("li");a.classList.add("page-item"),t===e&&a.classList.add("active"),a.innerHTML=`<a class="page-link" href="#" data-page="${t}">${t}</a>`,s.appendChild(a)}if(i<t){if(i<t-1){const t=document.createElement("li");t.classList.add("page-item","disabled"),t.innerHTML='<span class="page-link">...</span>',s.appendChild(t)}const e=document.createElement("li");e.classList.add("page-item"),e.innerHTML=`<a class="page-link" href="#" data-page="${t}">${t}</a>`,s.appendChild(e)}const l=document.createElement("li");l.classList.add("page-item"),e===t&&l.classList.add("disabled");l.innerHTML=`<a class="page-link" href="#" data-page="${e+1}">Sau</a>`,s.appendChild(l),s.querySelectorAll(".page-link").forEach(a=>{a.addEventListener("click",a=>{a.preventDefault();const n=parseInt(a.target.dataset.page);!isNaN(n)&&n>0&&n<=t&&n!==e&&(p(r,e=n),window.scrollTo({top:0,behavior:"smooth"}))})})}(h,c)):(t.innerHTML='<p class="text-center text-muted">Không tìm thấy truyện nào thuộc thể loại này.</p>',s.innerHTML="")}catch(a){console.error("Lỗi khi tải truyện theo thể loại:",a),t.innerHTML='<p class="text-center text-danger">Có lỗi xảy ra khi tải truyện. Vui lòng thử lại sau.</p>',e.style.display="none"}}r=d.get("genre")||"",c.addEventListener("submit",t=>{t.preventDefault();const e=l.value.trim();e&&(window.location.href=`search.html?keyword=${encodeURIComponent(e)}`)}),p(r,1),async function(){try{const t=(await axios.get(o)).data.data.items;i.innerHTML="",t.forEach(t=>{const e=document.createElement("li");e.innerHTML=`<a class="dropdown-item" href="genre.html?genre=${t.slug}">${t.name}</a>`,i.appendChild(e)})}catch(t){console.error("Lỗi khi tải thể loại:",t),i.innerHTML='<li><a class="dropdown-item" href="#">Lỗi tải thể loại</a></li>'}}()});
